# プロンプト管理システムリファクタリング完了レポート

**日付:** 2026年1月3日  
**作業者:** Claude Code  
**概要:** DataSourceとプロンプトファイル管理の大幅改善

## 📋 今回実施した変更

### 1. DataSourceモデル拡張
**ファイル:** `trail_status/models/source.py`

#### 追加フィールド
```python
prompt_key = models.CharField(
    "プロンプトキー", 
    max_length=50, 
    unique=True, 
    help_text="例: okutama_vc, kumotori_hut"
)
```

#### 新規プロパティ
```python
@property
def prompt_filename(self):
    """プロンプトファイル名: {id:03d}_{prompt_key}.yaml"""
    return f"{self.id:03d}_{self.prompt_key}.yaml"
```

### 2. プロンプトファイル命名規則変更
**ディレクトリ:** `trail_status/services/prompts/`

#### Before → After
```
okutama_vc.yaml     → 001_okutama_vc.yaml
mitake_vc.yaml      → 002_mitake_vc.yaml
template.yaml       → template.yaml (変更なし)
```

#### 新命名規則
- 形式: `{DataSource.id:03d}_{prompt_key}.yaml`
- 例: `001_okutama_vc.yaml`, `002_mitake_vc.yaml`
- メリット: 一意性保証、ファイル順序の安定化

### 3. LlmConfig大幅リファクタ
**ファイル:** `trail_status/services/llm_client.py`

#### 削除されたメソッド
- `from_site()` - classmethodを完全削除
- `_load_site_prompt()` - site_name概念廃止
- `_load_site_prompt_safe()` - 安全版も不要

#### 新規staticmethod
```python
@staticmethod
def load_prompt(filename: str) -> str:
    """
    プロンプトファイルを読み込み
    
    Args:
        filename: プロンプトファイル名（例：001_okutama_vc.yaml）
    
    Returns:
        str: プロンプト文字列
    
    Raises:
        FileNotFoundError: ファイルが存在しない場合
        ValueError: プロンプトが設定されていない場合
    """
```

#### 使用方法の変化
```python
# 【旧】複雑な推測ロジック
config = LlmConfig.from_site("okutama_vc", data=scraped_text, model=model)

# 【新】シンプルで直接的
prompt = LlmConfig.load_prompt("001_okutama_vc.yaml")
config = LlmConfig(site_prompt=prompt, data=scraped_text, model=model)
```

### 4. Pipelineクラス大幅簡素化
**ファイル:** `trail_status/services/pipeline.py`

#### 削除された機能
- `site_name_mapping` 辞書
- `_guess_site_name_from_data()` メソッド
- `add_site_mapping()` メソッド

#### 新規メソッド
```python
def _get_prompt_filename_from_data(self, source_data: SourceDataSingle) -> str:
    """ソースデータからプロンプトファイル名を取得"""
    source_id = source_data["id"]
    prompt_key = source_data["prompt_key"]
    return f"{source_id:03d}_{prompt_key}.yaml"
```

### 5. Management Command更新
**ファイル:** `trail_status/management/commands/trail_sync.py`

#### source_data_list構造変更
```python
# 【旧】prompt_key不足
source_data_list = [{"id": s.id, "name": s.name, "url1": s.url1}]

# 【新】prompt_key追加
source_data_list = [{"id": s.id, "name": s.name, "url1": s.url1, "prompt_key": s.prompt_key}]
```

### 6. LlmUsageモデル修正
**ファイル:** `trail_status/models/llm_usage.py`

#### フィールド修正
```python
# デフォルト値追加でNoneエラー解消
conditions_extracted = models.IntegerField("抽出された状況数", default=0)
cost_usd = models.DecimalField("コスト(USD)", max_digits=10, decimal_places=6, default=Decimal("0.000000"))
thinking_tokens = models.IntegerField("思考トークン数", default=0)  # 1→0に統一

# プロパティも安全に
@property
def cost_per_condition(self):
    if self.conditions_extracted and self.conditions_extracted > 0:
        return self.cost_usd / self.conditions_extracted
    return Decimal("0")
```

### 7. 管理画面改善
**ファイル:** `trail_status/admin.py`

#### DataSourceAdmin更新
```python
list_display = ["id", "name", "prompt_key", "organization_type", "prefecture_code", "url1"]
```

#### LlmUsageAdmin追加
```python
@admin.register(LlmUsage)
class LlmUsageAdmin(admin.ModelAdmin):
    list_display = ["executed_at", "source", "model", "cost_usd", "conditions_extracted", ...]
    list_filter = ["model", "success", ("executed_at", admin.DateFieldListFilter), "source"]
```

## 🔧 現在の状態

### システム構成
```
DataSource (DB)
    ↓ prompt_key
プロンプトファイル ({id:03d}_{prompt_key}.yaml)
    ↓ LlmConfig.load_prompt()
LlmConfig インスタンス
    ↓ AIクライアント
結果 → LlmUsage (コスト追跡)
```

### データフロー
1. **DataSource取得**: 管理画面またはAPI
2. **ファイル名生成**: `source.prompt_filename` プロパティ
3. **プロンプト読み込み**: `LlmConfig.load_prompt(filename)`
4. **Config作成**: `LlmConfig(site_prompt, data, model)`
5. **AI実行**: DeepseekClient/GeminiClient
6. **結果保存**: TrailCondition + LlmUsage

### プロンプトファイル管理
- **場所**: `trail_status/services/prompts/`
- **命名**: `001_okutama_vc.yaml`, `002_mitake_vc.yaml`
- **構造**: YAML形式、`prompt` キーに内容
- **一意性**: DataSource.id で保証

## 🎯 改善されたポイント

### 1. **一意性の保証**
- ファイル名衝突の完全回避
- DataSource.id + prompt_key の組み合わせ

### 2. **直感的なAPI**
- `from_site("okutama_vc")` → `load_prompt("001_okutama_vc.yaml")`
- 推測ロジック排除、直接指定

### 3. **責任分離**
- ファイル読み込み: `LlmConfig.load_prompt()`
- 設定構築: `LlmConfig()`
- オーケストレーション: Pipeline

### 4. **拡張性**
- 新サイト追加 = DataSource作成 + YAMLファイル追加
- 特殊プロンプト = YAMLファイルのカスタマイズ
- テスト = 各コンポーネント個別テスト可能

### 5. **運用性**
- 管理画面でprompt_key設定可能
- ファイル名からDataSource.id特定可能
- LlmUsage完全追跡

## 🚀 次にやるべきこと

### 1. 【必須】マイグレーション実行
```bash
# DataSourceにprompt_keyフィールド追加
python manage.py makemigrations
python manage.py migrate
```

### 2. 【必須】既存DataSourceデータ更新
管理画面または以下で既存レコードにprompt_key設定:
```python
# 例: 既存レコードの更新
DataSource.objects.filter(id=1).update(prompt_key="okutama_vc")
DataSource.objects.filter(id=2).update(prompt_key="mitake_vc")
```

### 3. 【推奨】動作確認テスト
```bash
# 新システムでの実行テスト
python manage.py trail_sync --dry-run
python manage.py trail_sync --source 1  # 奥多摩のみテスト
```

### 4. 【オプション】プロンプト改善
- 山名抽出精度向上（特に奥多摩）
- 新しいサイト追加対応
- エラーハンドリング強化

### 5. 【将来】通貨変換実装
- Yahoo Finance API統合
- 日本円での表示機能

## 📊 予想される効果

### 直接的効果
- プロンプト管理の一意性と安全性向上
- デバッグ効率の大幅改善
- 新サイト追加の標準化

### 間接的効果
- システム全体の保守性向上
- チーム開発での混乱減少
- 将来の機能拡張の基盤強化

## 💡 学んだポイント

1. **YAGNI原則**: 不要な抽象化（from_prompt_file）を避ける
2. **命名の重要性**: 直感的で明確な名前が開発効率を上げる
3. **段階的リファクタ**: 小さな変更の積み重ねで大きな改善
4. **責任分離**: 各クラス・メソッドの役割を明確に

---

**この変更により、プロンプト管理が非常にクリーンで拡張しやすいシステムになりました！** 🎉